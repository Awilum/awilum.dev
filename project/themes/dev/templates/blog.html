{% extends 'themes/' ~ flextype.registry.get('plugins.site.settings.theme') ~ '/templates/partials/base.html' %}

{% block content %}

    {% set page = request.getQueryParams().page %}
    {% set tag = request.getQueryParams().tag %}

    {% set blogID = flextype.registry.get('themes.dev.settings.blog_id') %}
    {% set blogCollectionCacheID = strings('blog-collection-' ~ blogID).hash().toString() %}
    {% if flextype.cache.has(blogCollectionCacheID) %}
        {% set blog = flextype.cache.get(blogCollectionCacheID) %}
    {% else %}
        {% set blog = flextype.entries.fetch(blogID, {'collection': true}).exceptFromCollection(['content']) %}
        {% do flextype.cache.set(blogCollectionCacheID, blog) %}
    {% endif %}

    {% set blogPostData = flextype.entries.fetch(blogID) %}
    {% if blogPostData.posts_limit == 0 %}{% set blogPostsLimit = 10 %}{% else %}{% set blogPostsLimit = blogPostData.posts_limit %}{% endif %}

    {% if tag %}
        {% set blogPostsLength = blog.copy()
                                        .where('tags', 'contains', tag)
                                        .where('visibility', 'nin', ['draft', 'hidden'])
                                        .count() %}
        {% set blogPostsPages = (blogPostsLength / blogPostsLimit)|round(0, 'ceil') %}

        {% if page < 1 %}
            {% set page = 1 %}
        {% elseif page > blogPostsPages %}
            {% set page = blogPostsPages %}
        {% endif %}

        {% set blogPostsOffset = (page - 1 ) * blogPostsLimit %}
        {% if blogPostsOffset < 0 %}{% set blogPostsOffset = 0 %}{% endif %}

        {% set blogPosts = blog.copy()
                                .where('tags', 'contains', tag)
                                .where('visibility', 'nin', ['draft', 'hidden'])
                                .sortBy('published_at', 'DESC')
                                .slice(blogPostsOffset, blogPostsLimit) %}
    {% else %}

        {% set blogPostsLength = blog.copy().where('visibility', 'nin', ['draft', 'hidden']).count() %}
        {% set blogPostsPages = (blogPostsLength / blogPostsLimit)|round(0, 'ceil') %}

        {% if page < 1 %}
            {% set page = 1 %}
        {% elseif page > blogPostsPages %}
            {% set page = blogPostsPages %}
        {% endif %}

        {% set blogPostsOffset = (page - 1) * blogPostsLimit %}
        {% if blogPostsOffset < 0 %}{% set blogPostsOffset = 0 %}{% endif %}

        {% set blogPosts = blog.copy()
                                .where('visibility', 'nin', ['draft', 'hidden'])
                                .sortBy('published_at', 'DESC')
                                .slice(blogPostsOffset, blogPostsLimit) %}

    {% endif %}

    <div class="flex mt-4">
        <div class="w-9/12">
            {# blog-posts #}
            {% for post in blogPosts %} 
                <div class="p-6 py-0 bg-white dark:bg-slate-800 mb-4 border border-black flex items-center" style="box-shadow: 3px 3px 0 black">
                    <h3 class="w-10/12 py-2 text-base font-bold m-0 border-r border-black" style="padding-top: 13.5px; padding-bottom: 13.5px;">
                        <a href="{{ post.id }}" style="text-decoration: none;">{{ post.title }}</a>
                    </h3>
                    <div class="w-3/12 py-2 text-xs pl-4 opacity-60">
                        <strong>Date:</strong> {{ post.published_at|date("M d Y") }}<br>
                        <strong>Views:</strong> {{ pageViewCounterStats(post.id) }}
                    </div>
                </div>
            {% endfor %}
            {# /blog-posts #}
        </div>
        <div class="w-3/12 pl-5">
            <div class="p-6 bg-white dark:bg-slate-800 mb-4 border border-black" style="box-shadow: 3px 3px 0 black">
                <h3 class="text-xl font-bold pb-4 pt-0 mb-4 mt-0 p-0 border-b border-black">Popular Tags</h3>
                {# tags-cloud #}
                {% include 'themes/' ~ flextype.registry.get('plugins.site.settings.theme') ~ '/templates/partials/blog/tags-cloud.html' %}
                {# /tags-cloud #}
            </div>
        </div>
    </div>

    {# pagination-navigation #}
    {% include 'themes/' ~ flextype.registry.get('plugins.site.settings.theme') ~ '/templates/partials/blog/pagination-navigation.html' %}
    {# /pagination-navigation #}
{% endblock %}
