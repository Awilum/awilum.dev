{% extends 'themes/' ~ flextype.registry.get('plugins.site.settings.theme') ~ '/templates/partials/base.html' %}

{% block content %}

    {% set page = request.getQueryParams().page %}
    {% set tag = request.getQueryParams().tag %}

    {% set blogID = flextype.registry.get('themes.dev.settings.blog_id') %}
    {% set blogCollectionCacheID = strings('blog-collection-' ~ blogID).hash().toString() %}
    {% if flextype.cache.has(blogCollectionCacheID) %}
        {% set blog = flextype.cache.get(blogCollectionCacheID) %}
    {% else %}
        {% set blog = flextype.entries.fetch(blogID, {'collection': true}).exceptFromCollection(['content']) %}
        {% do flextype.cache.set(blogCollectionCacheID, blog) %}
    {% endif %}

    {% set blogPostData = flextype.entries.fetch(blogID) %}
    {% if blogPostData.posts_limit == 0 %}{% set blogPostsLimit = 5 %}{% else %}{% set blogPostsLimit = blogPostData.posts_limit %}{% endif %}
    {% if blogPostData.posts_recent_limit == 0 %}{% set blogPostsRecentLimit = 5 %}{% else %}{% set blogPostsRecentLimit = blogPostData.posts_recent_limit %}{% endif %}
    {% if blogPostData.posts_random_limit == 0 %}{% set blogPostsRandomLimit = 5 %}{% else %}{% set blogPostsRandomLimit = blogPostData.posts_random_limit %}{% endif %}

    {% if tag %}
        {% set blogPostsLength = blog.copy()
                                        .where('tags', 'contains', tag)
                                        .where('visibility', 'nin', ['draft', 'hidden'])
                                        .count() %}
        {% set blogPostsPages = (blogPostsLength / blogPostsLimit)|round(0, 'ceil') %}

        {% if page < 1 %}
            {% set page = 1 %}
        {% elseif page > blogPostsPages %}
            {% set page = blogPostsPages %}
        {% endif %}

        {% set blogPostsOffset = (page - 1 ) * blogPostsLimit %}
        {% if blogPostsOffset < 0 %}{% set blogPostsOffset = 0 %}{% endif %}

        {% set blogPosts = blog.copy()
                                .where('tags', 'contains', tag)
                                .where('visibility', 'nin', ['draft', 'hidden'])
                                .sortBy('published_at', 'DESC')
                                .slice(blogPostsOffset, blogPostsLimit) %}
    {% else %}

        {% set blogPostsLength = blog.copy().where('visibility', 'nin', ['draft', 'hidden']).count() %}
        {% set blogPostsPages = (blogPostsLength / blogPostsLimit)|round(0, 'ceil') %}

        {% if page < 1 %}
            {% set page = 1 %}
        {% elseif page > blogPostsPages %}
            {% set page = blogPostsPages %}
        {% endif %}

        {% set blogPostsOffset = (page - 1) * blogPostsLimit %}
        {% if blogPostsOffset < 0 %}{% set blogPostsOffset = 0 %}{% endif %}

        {% set blogPosts = blog.copy()
                                .where('visibility', 'nin', ['draft', 'hidden'])
                                .sortBy('published_at', 'DESC')
                                .slice(blogPostsOffset, blogPostsLimit) %}

    {% endif %}

    <div class="flex">
        <div class="w-9/12">
            {# blog-posts #}
            {% for post in blogPosts %} 
                <div class="p-6 bg-slate-50 mb-4 border-2 border-black">
                    <h3 class="text-xl font-bold pb-4 pt-0 mb-4 mt-0 p-0 border-b border-black"><a href="{{ post.id }}" style="text-decoration: none;">{{ post.title }}</a></h3>
                    <div class="text-xs opacity-60">
                        <strong>Date:</strong> {{ post.published_at|date("M d Y") }}
                        <strong class="ml-2">Tags:</strong>
                        {% if post.tags is not empty %}
                        {% for tag in post.tags|split(',') %}
                            <a href="{{ url() }}/blog?tag={{ tag|trim }}">{{ tag|trim }}</a>
                        {% endfor %}
                        <strong class="ml-2">Views:</strong>
                        {{ pageViewCounterStats(post.id) }}
                    {% endif %}
                    </div>
                </div>
            {% endfor %}
            {# /blog-posts #}
        </div>
        <div class="w-3/12 pl-5">
            <div class="p-6 bg-slate-50 mb-4 border-2 border-black">
                <h3 class="text-xl font-bold pb-4 pt-0 mb-4 mt-0 p-0 border-b border-black">Popular Tags</h3>
                {# tags-cloud #}
                {% include 'themes/' ~ flextype.registry.get('plugins.site.settings.theme') ~ '/templates/partials/blog/tags-cloud.html' %}
                {# /tags-cloud #}
            </div>
        </div>
    </div>


    {# pagination-navigation #}
    {% include 'themes/' ~ flextype.registry.get('plugins.site.settings.theme') ~ '/templates/partials/blog/pagination-navigation.html' %}
    {# /pagination-navigation #}
{% endblock %}
